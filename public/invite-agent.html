<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ëŒ€ë¦¬ì¸ ì´ˆëŒ€</title>
    <style>
      body {
        font-family: "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
      }
      .header {
        background-color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .logo {
        font-weight: bold;
        font-size: 20px;
        color: #333;
      }
      .user-info {
        display: flex;
        align-items: center;
      }
      .user-name {
        margin-right: 15px;
        font-weight: 500;
      }
      .logout-button {
        background-color: #f1f3f5;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }
      .logout-button:hover {
        background-color: #e9ecef;
      }
      .container {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
      }
      .page-title {
        color: #333;
        margin-bottom: 30px;
        font-size: 24px;
      }
      .card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 30px;
      }
      .card-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
      }
      .card-icon {
        margin-right: 10px;
        font-size: 20px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #ffeb00;
        box-shadow: 0 0 0 2px rgba(255, 235, 0, 0.2);
      }
      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      .button {
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .button:hover {
        background-color: #45a049;
      }
      .button-secondary {
        background-color: #f1f3f5;
        color: #333;
      }
      .button-secondary:hover {
        background-color: #e9ecef;
      }
      .info-text {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
      }
      .agent-list {
        margin-top: 30px;
      }
      .agent-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
      }
      .agent-info {
        flex: 1;
      }
      .agent-name {
        font-weight: 500;
        margin-bottom: 5px;
      }
      .agent-email {
        color: #666;
        font-size: 14px;
      }
      .agent-relation {
        color: #888;
        font-size: 12px;
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 10px;
      }
      .agent-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }
      .status-pending {
        background-color: #ffe066;
        color: #f59f00;
      }
      .status-auth-required {
        background-color: #ff8787;
        color: #d63031;
      }
      .status-active {
        background-color: #d3f9d8;
        color: #2f9e44;
      }
      .agent-actions {
        margin-left: 10px;
        display: flex;
        gap: 8px;
      }
      .agent-button {
        background-color: #f1f3f5;
        color: #333;
        border: none;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .agent-button:hover {
        background-color: #e9ecef;
      }
      .agent-button-danger {
        color: #e03131;
      }
      .agent-button-danger:hover {
        background-color: #ffdeeb;
      }
      .checkbox-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .checkbox-container input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
      }
      .permission-list {
        border: 1px solid #eee;
        border-radius: 6px;
        margin-top: 15px;
        padding: 15px;
      }
      .permission-label {
        font-weight: 500;
        margin-bottom: 10px;
        color: #333;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .toast.show {
        opacity: 1;
      }
      .empty-state {
        text-align: center;
        padding: 40px 0;
        color: #888;
      }
      .empty-icon {
        font-size: 40px;
        margin-bottom: 15px;
        opacity: 0.5;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }
      .modal-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="logo">ë””ì§€í„¸ ì‚¬í›„ ê´€ë¦¬ ì›¹ì•±</div>
      <div class="user-info">
        <span class="user-name" id="username">ì‚¬ìš©ìëª…</span>
        <button class="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="container">
      <h1 class="page-title">ëŒ€ë¦¬ì¸ ì´ˆëŒ€</h1>

      <div class="card">
        <h2 class="card-title">
          <span class="card-icon">ğŸ‘¤</span>
          ìƒˆ ëŒ€ë¦¬ì¸ ì´ˆëŒ€
        </h2>

        <p>
          ì‚¬ë§ í›„ ê·€í•˜ì˜ ë””ì§€í„¸ ìì‚°ì„ ê´€ë¦¬í•  ëŒ€ë¦¬ì¸ì„ ì´ˆëŒ€í•˜ì„¸ìš”. ëŒ€ë¦¬ì¸ì€ ë³¸ì¸
          ì¸ì¦ ë° 2ë‹¨ê³„ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ê¶Œí•œì´ í™œì„±í™”ë©ë‹ˆë‹¤.
        </p>

        <form id="invite-form">
          <div class="form-group">
            <label for="agent-name">ëŒ€ë¦¬ì¸ ì´ë¦„</label>
            <input
              type="text"
              id="agent-name"
              placeholder="ëŒ€ë¦¬ì¸ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>

          <div class="form-group">
            <label for="agent-email">ëŒ€ë¦¬ì¸ ì´ë©”ì¼</label>
            <input
              type="email"
              id="agent-email"
              placeholder="ëŒ€ë¦¬ì¸ì˜ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>

          <div class="form-group">
            <label for="agent-phone">ëŒ€ë¦¬ì¸ íœ´ëŒ€í° ë²ˆí˜¸</label>
            <input
              type="tel"
              id="agent-phone"
              placeholder="'-' ì—†ì´ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>

          <div class="form-group">
            <label for="agent-relation">ëŒ€ë¦¬ì¸ê³¼ì˜ ê´€ê³„</label>
            <select id="agent-relation" required>
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="ê°€ì¡±">ê°€ì¡±</option>
              <option value="ì¹œêµ¬">ì¹œêµ¬</option>
              <option value="ë³€í˜¸ì‚¬">ë³€í˜¸ì‚¬</option>
              <option value="íšŒê³„ì‚¬">íšŒê³„ì‚¬</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>

          <div class="form-group">
            <label>ëŒ€ë¦¬ì¸ ê¶Œí•œ ì„¤ì •</label>
            <div class="permission-list">
              <div class="permission-label">SNS ë°ì´í„° ê¶Œí•œ</div>
              <div class="checkbox-container">
                <input type="checkbox" id="perm-kakao-profile" />
                <label for="perm-kakao-profile"
                  >ì¹´ì¹´ì˜¤ í”„ë¡œí•„ ì¡°íšŒ ë° ê´€ë¦¬</label
                >
              </div>
              <div class="checkbox-container">
                <input type="checkbox" id="perm-kakao-messages" />
                <label for="perm-kakao-messages"
                  >ì¹´ì¹´ì˜¤ ë©”ì‹œì§€ ì¡°íšŒ ë° ê´€ë¦¬</label
                >
              </div>
              <!-- í–¥í›„ ì¶”ê°€: í˜ì´ìŠ¤ë¶, ì¸ìŠ¤íƒ€ê·¸ë¨ ë“± -->
              <div class="permission-label">ì´ë©”ì¼ ë°ì´í„° ê¶Œí•œ</div>
              <div class="checkbox-container">
                <input type="checkbox" id="perm-email" />
                <label for="perm-email">ì´ë©”ì¼ ë°ì´í„° ì¡°íšŒ ë° ê´€ë¦¬</label>
              </div>
              <div class="permission-label">í´ë¼ìš°ë“œ ë°ì´í„° ê¶Œí•œ</div>
              <div class="checkbox-container">
                <input type="checkbox" id="perm-cloud" />
                <label for="perm-cloud">í´ë¼ìš°ë“œ ë°ì´í„° ì¡°íšŒ ë° ê´€ë¦¬</label>
              </div>
              <div class="permission-label">ì‚¬í›„ ì§€ì¹¨</div>
              <div class="checkbox-container">
                <input type="checkbox" id="perm-instructions" />
                <label for="perm-instructions">ì‚¬í›„ ì§€ì¹¨ ì‹¤í–‰</label>
              </div>
            </div>
            <p class="info-text">
              * ëŒ€ë¦¬ì¸ì€ ì‚¬ìš©ìì˜ ì‚¬ë§ì´ í™•ì¸ëœ í›„ì—ë§Œ ê¶Œí•œì´ í™œì„±í™”ë©ë‹ˆë‹¤.
            </p>
          </div>

          <div class="actions">
            <button
              type="button"
              class="button button-secondary"
              onclick="goBack()"
            >
              ì·¨ì†Œ
            </button>
            <button type="button" class="button" onclick="inviteAgent()">
              ëŒ€ë¦¬ì¸ ì´ˆëŒ€í•˜ê¸°
            </button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2 class="card-title">
          <span class="card-icon">ğŸ‘¥</span>
          ëŒ€ë¦¬ì¸ ëª©ë¡
        </h2>

        <div id="agent-list" class="agent-list">
          <div class="empty-state" id="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <p>
              ë“±ë¡ëœ ëŒ€ë¦¬ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ëŒ€ë¦¬ì¸ì„ ì´ˆëŒ€í•˜ì—¬ ë””ì§€í„¸ ì‚¬í›„ ê´€ë¦¬ë¥¼
              ì‹œì‘í•˜ì„¸ìš”.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div class="toast" id="toast">ëŒ€ë¦¬ì¸ ì´ˆëŒ€ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal" id="delete-modal">
      <div class="modal-content">
        <h3 class="modal-title">ëŒ€ë¦¬ì¸ ì‚­ì œ</h3>
        <p>ì •ë§ ì´ ëŒ€ë¦¬ì¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <div class="modal-actions">
          <button class="button button-secondary" onclick="closeModal()">
            ì·¨ì†Œ
          </button>
          <button
            class="button"
            style="background-color: #e03131"
            onclick="confirmDelete()"
          >
            ì‚­ì œ
          </button>
        </div>
      </div>
    </div>

    <script>
      // ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      fetch("/api/user-info")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("username").textContent = data.name;
        })
        .catch((error) => {
          console.error("Error:", error);
        });

      // ëŒ€ë¦¬ì¸ ë°ì´í„° (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥)
      let agents = JSON.parse(localStorage.getItem("digitalAgents")) || [];
      let currentDeleteId = null;

      // í˜ì´ì§€ ë¡œë“œì‹œ ëŒ€ë¦¬ì¸ ëª©ë¡ í‘œì‹œ
      document.addEventListener("DOMContentLoaded", function () {
        displayAgents();
      });

      // ëŒ€ë¦¬ì¸ ì´ˆëŒ€í•˜ê¸°
      async function inviteAgent() {
        const name = document.getElementById("agent-name").value;
        const email = document.getElementById("agent-email").value;
        const phone = document.getElementById("agent-phone").value;
        const relation = document.getElementById("agent-relation").value;

        // ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬
        if (!name || !email || !phone || !relation) {
          showToast("ëª¨ë“  í•„ìˆ˜ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ê¶Œí•œ ì •ë³´ ìˆ˜ì§‘
        const permissions = {
          kakaoProfile: document.getElementById("perm-kakao-profile").checked,
          kakaoMessages: document.getElementById("perm-kakao-messages").checked,
          email: document.getElementById("perm-email").checked,
          cloud: document.getElementById("perm-cloud").checked,
          instructions: document.getElementById("perm-instructions").checked,
        };

        // ìƒˆ ëŒ€ë¦¬ì¸ ê°ì²´ ìƒì„±
        const newAgent = {
          id: Date.now(), // ê°„ë‹¨í•œ ê³ ìœ  ID
          name: name,
          email: email,
          phone: phone,
          relation: relation,
          permissions: permissions,
          status: "pending", // ì´ˆëŒ€ í›„ ì¸ì¦ ëŒ€ê¸° ìƒíƒœ
          isAuthenticated: false, // ë³¸ì¸ ì¸ì¦ ì—¬ë¶€
          invitedAt: new Date().toISOString(),
          inviteLink: `/agent/accept-invite/${Date.now()}`, // ì´ˆëŒ€ ë§í¬ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ìƒì„±í•´ì•¼ í•¨)
        };

        // ì„œë²„ë¡œ ì´ˆëŒ€ ìš”ì²­ ë³´ë‚´ê¸°
        try {
          const response = await fetch("/api/invite-agent", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(newAgent),
          });

          if (response.ok) {
            agents.push(newAgent);
            saveAgents();
            displayAgents();

            // í¼ ì´ˆê¸°í™”
            document.getElementById("invite-form").reset();

            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
            showToast("ëŒ€ë¦¬ì¸ ì´ˆëŒ€ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } else {
            showToast("ëŒ€ë¦¬ì¸ ì´ˆëŒ€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("ëŒ€ë¦¬ì¸ ì´ˆëŒ€ ì˜¤ë¥˜:", error);
          showToast("ëŒ€ë¦¬ì¸ ì´ˆëŒ€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ëŒ€ë¦¬ì¸ ëª©ë¡ í‘œì‹œ
      function displayAgents() {
        const listElement = document.getElementById("agent-list");
        const emptyState = document.getElementById("empty-state");

        // ëª¨ë“  ìì‹ ìš”ì†Œ ì œê±°
        while (listElement.firstChild) {
          listElement.removeChild(listElement.firstChild);
        }

        // empty-state ë‹¤ì‹œ ì¶”ê°€
        listElement.appendChild(emptyState);

        // ëŒ€ë¦¬ì¸ì´ ì—†ëŠ” ê²½ìš° empty-state í‘œì‹œ
        if (agents.length === 0) {
          emptyState.style.display = "block";
          return;
        }

        // empty-state ìˆ¨ê¸°ê¸°
        emptyState.style.display = "none";

        // ëŒ€ë¦¬ì¸ ëª©ë¡ ìƒì„±
        agents.forEach((agent) => {
          let statusClass, statusText;
          if (agent.status === "pending" && !agent.isAuthenticated) {
            statusClass = "status-auth-required";
            statusText = "ë³¸ì¸ ì¸ì¦ í•„ìš”";
          } else if (agent.status === "pending") {
            statusClass = "status-pending";
            statusText = "ì‚¬ë§ í™•ì¸ ëŒ€ê¸°ì¤‘";
          } else {
            statusClass = "status-active";
            statusText = "í™œì„±í™”ë¨";
          }

          const agentItem = document.createElement("div");
          agentItem.className = "agent-item";

          agentItem.innerHTML = `
          <div class="agent-info">
            <div class="agent-name">${agent.name}
              <span class="agent-relation">${agent.relation}</span>
            </div>
            <div class="agent-email">${agent.email} | ${agent.phone}</div>
          </div>
          <span class="agent-status ${statusClass}">${statusText}</span>
          <div class="agent-actions">
            <button class="agent-button" onclick="resendInvite(${agent.id})">
              <span>ì¬ì´ˆëŒ€</span>
            </button>
            <button class="agent-button agent-button-danger" onclick="deleteAgent(${agent.id})">
              <span>ì‚­ì œ</span>
            </button>
          </div>
        `;

          listElement.appendChild(agentItem);
        });

        // ë§ˆì§€ë§‰ í•­ëª©ì˜ border-bottom ì œê±°
        if (
          listElement.lastChild &&
          listElement.lastChild.classList.contains("agent-item")
        ) {
          listElement.lastChild.style.borderBottom = "none";
        }
      }

      // ëŒ€ë¦¬ì¸ ì¬ì´ˆëŒ€
      async function resendInvite(id) {
        const agent = agents.find((a) => a.id === id);
        if (agent) {
          try {
            const response = await fetch("/api/resend-invite", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ agentId: id, email: agent.email }),
            });

            if (response.ok) {
              showToast(`${agent.name}ë‹˜ì—ê²Œ ì´ˆëŒ€ ë§í¬ê°€ ì¬ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
              showToast("ì´ˆëŒ€ ë§í¬ ì¬ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("ì´ˆëŒ€ ë§í¬ ì¬ì „ì†¡ ì˜¤ë¥˜:", error);
            showToast("ì´ˆëŒ€ ë§í¬ ì¬ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      // ëŒ€ë¦¬ì¸ ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
      function deleteAgent(id) {
        currentDeleteId = id;
        document.getElementById("delete-modal").style.display = "flex";
      }

      // ëŒ€ë¦¬ì¸ ì‚­ì œ í™•ì¸
      function confirmDelete() {
        if (currentDeleteId) {
          agents = agents.filter((agent) => agent.id !== currentDeleteId);
          saveAgents();
          displayAgents();
          closeModal();
          showToast("ëŒ€ë¦¬ì¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      function closeModal() {
        document.getElementById("delete-modal").style.display = "none";
        currentDeleteId = null;
      }

      // ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
      function goBack() {
        window.location.href = "/home.html";
      }

      // ë¡œê·¸ì•„ì›ƒ
      function logout() {
        fetch("/auth/logout", { method: "POST" }).then(() => {
          window.location.href = "/";
        });
      }

      // ì—ì´ì „íŠ¸ ì €ì¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€)
      function saveAgents() {
        localStorage.setItem("digitalAgents", JSON.stringify(agents));
      }

      // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'930c55f9cbbb53c1',t:'MTc0NDcyOTQ3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
